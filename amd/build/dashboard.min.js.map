{"version":3,"file":"dashboard.min.js","sources":["../src/dashboard.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Dashboard AMD module for Integration Hub.\n *\n * Handles chart rendering (Chart.js) and service-form UI interactions\n * (show/hide AMQP builder, type-toggle, AMQP URL sync).\n *\n * @module     local_integrationhub/dashboard\n * @copyright  2026 Integration Hub Contributors\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* global Chart */\ndefine(\n    ['core/notification'],\n    function (Notification) {\n\n        return {\n            init: function (data, strings) {\n\n                try {\n                    const form = document.getElementById('ih-service-form');\n                    const btnAdd = document.getElementById('ih-btn-add');\n                    const btnCancel = document.getElementById('ih-btn-cancel');\n\n                    if (btnAdd && form) {\n                        btnAdd.addEventListener('click', function () {\n                            const svcId = document.getElementById('ih-serviceid');\n                            const ihForm = document.getElementById('ih-form');\n\n                            if (svcId) {\n                                svcId.value = '0';\n                            }\n\n                            if (ihForm) {\n                                ihForm.reset();\n                            }\n\n                            form.classList.remove('d-none');\n                            btnAdd.classList.add('d-none');\n\n                            const nameField = document.getElementById('ih-name');\n                            if (nameField) {\n                                nameField.focus();\n                            }\n                        });\n                    }\n\n                    if (btnCancel && form) {\n                        btnCancel.addEventListener('click', function () {\n                            form.classList.add('d-none');\n                            if (btnAdd) {\n                                btnAdd.classList.remove('d-none');\n                            }\n                        });\n                    }\n\n                    const typeField = document.getElementById('ih-type');\n                    const urlField = document.getElementById('ih-base_url');\n                    const urlHelp = document.getElementById('ih-base_url-help');\n                    const amqpBuilder = document.getElementById('ih-amqp-builder');\n                    const baseUrlContainer =\n                        document.querySelector('.ih-base-url-container');\n                    // authTypeContainer and responseQueueContainer were\n                    // previously toggled by an inline <script>; now handled here.\n                    const authTypeContainer = document.getElementById('ih-auth_type')\n                        ? document.getElementById('ih-auth_type').closest('.col-md-6')\n                        : null;\n                    const responseQueueContainer = document.getElementById('ih-response_queue')\n                        ? document.getElementById('ih-response_queue').closest('.col-md-6')\n                        : null;\n\n                    const updateUiForType = function () {\n                        const type = typeField.value || 'rest';\n\n                        if (type === 'amqp') {\n                            urlHelp.textContent = strings.url_help_amqp;\n\n                            if (amqpBuilder) {\n                                amqpBuilder.classList.remove('d-none');\n                            }\n\n                            if (baseUrlContainer) {\n                                baseUrlContainer.classList.add('d-none');\n                            }\n\n                            if (authTypeContainer) {\n                                authTypeContainer.classList.add('d-none');\n                            }\n\n                            if (responseQueueContainer) {\n                                responseQueueContainer.classList.add('d-none');\n                            }\n                        } else {\n                            // If switching away from AMQP and the URL is an AMQP one, clear it.\n                            if (urlField.value && (urlField.value.startsWith('amqp://') || urlField.value.startsWith('amqps://'))) {\n                                urlField.value = '';\n                            }\n\n                            urlHelp.textContent = strings.url_help_rest;\n\n                            if (amqpBuilder) {\n                                amqpBuilder.classList.add('d-none');\n                            }\n\n                            if (baseUrlContainer) {\n                                baseUrlContainer.classList.remove('d-none');\n                            }\n\n                            if (authTypeContainer) {\n                                authTypeContainer.classList.remove('d-none');\n                            }\n\n                            if (responseQueueContainer) {\n                                responseQueueContainer.classList.remove('d-none');\n                            }\n                        }\n                    };\n\n                    const syncAmqpUrl = function () {\n                        const host =\n                            document.getElementById('ih-amqp_host').value ||\n                            'localhost';\n\n                        const port =\n                            document.getElementById('ih-amqp_port').value ||\n                            '5672';\n\n                        const user =\n                            document.getElementById('ih-amqp_user').value ||\n                            'guest';\n\n                        const pass =\n                            document.getElementById('ih-amqp_pass').value ||\n                            'guest';\n\n                        let vhost =\n                            document.getElementById('ih-amqp_vhost').value || '/';\n\n                        const exchange =\n                            document.getElementById('ih-amqp_exchange').value;\n\n                        const routingKey =\n                            document.getElementById('ih-amqp_routing_key').value;\n\n                        const queueDeclare =\n                            document.getElementById('ih-amqp_queue_declare').value;\n\n                        const dlq =\n                            document.getElementById('ih-amqp_dlq').value;\n\n                        if (vhost !== '/' && vhost.startsWith('/')) {\n                            vhost = vhost.substring(1);\n                        }\n\n                        const eUser = encodeURIComponent(user);\n                        const ePass = encodeURIComponent(pass);\n                        const eHost = encodeURIComponent(host);\n\n                        let eVhost = '';\n                        if (vhost !== '/') {\n                            eVhost = encodeURIComponent(vhost);\n                        }\n\n                        const scheme = (port === '5671') ? 'amqps' : 'amqp';\n\n                        let url =\n                            scheme + '://' + eUser + ':' + ePass + '@' +\n                            eHost + ':' + port + '/' + eVhost;\n\n                        const params = [];\n\n                        if (exchange) {\n                            params.push(\n                                'exchange=' +\n                                encodeURIComponent(exchange)\n                            );\n                        }\n\n                        if (routingKey) {\n                            params.push(\n                                'routing_key=' +\n                                encodeURIComponent(routingKey)\n                            );\n                        }\n\n                        if (queueDeclare) {\n                            params.push(\n                                'queue_declare=' +\n                                encodeURIComponent(queueDeclare)\n                            );\n                        }\n\n                        if (dlq) {\n                            params.push(\n                                'dlq=' +\n                                encodeURIComponent(dlq)\n                            );\n                        }\n\n                        if (params.length > 0) {\n                            url += '?' + params.join('&');\n                        }\n\n                        if (urlField) {\n                            urlField.value = url;\n                        }\n                    };\n\n                    if (typeField && urlHelp) {\n                        typeField.addEventListener(\n                            'change',\n                            updateUiForType\n                        );\n\n                        typeField.addEventListener('change', function () {\n                            if (typeField.value === 'amqp') {\n                                syncAmqpUrl();\n                            }\n                        });\n\n                        document\n                            .querySelectorAll('.ih-amqp-sync')\n                            .forEach(function (el) {\n                                el.addEventListener(\n                                    'input',\n                                    syncAmqpUrl\n                                );\n                            });\n\n                        updateUiForType();\n\n                        if (typeField.value === 'amqp') {\n                            syncAmqpUrl();\n                        }\n                    }\n                } catch (e) {\n                    Notification.exception(e);\n                }\n\n                try {\n                    const elStatus =\n                        document.getElementById('ih-chart-status');\n\n                    if (typeof Chart !== 'undefined' && elStatus) {\n                        const ctxStatus =\n                            elStatus.getContext('2d');\n\n                        new Chart(ctxStatus, {\n                            type: 'doughnut',\n                            data: {\n                                labels: [\n                                    strings.success,\n                                    strings.failure\n                                ],\n                                datasets: [{\n                                    data: [\n                                        data.success || 0,\n                                        data.fail || 0\n                                    ],\n                                    backgroundColor: [\n                                        '#198754',\n                                        '#dc3545'\n                                    ]\n                                }]\n                            },\n                            options: {\n                                responsive: true,\n                                maintainAspectRatio: false\n                            }\n                        });\n                    }\n\n                    const elLatency =\n                        document.getElementById('ih-chart-latency');\n\n                    if (typeof Chart !== 'undefined' && elLatency) {\n                        const ctxLatency =\n                            elLatency.getContext('2d');\n\n                        if (!data.labels ||\n                            data.labels.length === 0) {\n                            ctxLatency.font =\n                                '14px sans-serif';\n\n                            ctxLatency.fillStyle =\n                                '#6c757d';\n\n                            ctxLatency.textAlign =\n                                'center';\n\n                            ctxLatency.fillText(\n                                'No latency data available yet',\n                                elLatency.width / 2,\n                                elLatency.height / 2\n                            );\n                        } else {\n                            new Chart(ctxLatency, {\n                                type: 'line',\n                                data: {\n                                    labels: data.labels,\n                                    datasets: [{\n                                        label:\n                                            strings.avglatency,\n                                        data: data.latency,\n                                        borderColor:\n                                            '#0d6efd',\n                                        backgroundColor:\n                                            'rgba(13,110,253,0.1)',\n                                        tension: 0.3,\n                                        fill: true\n                                    }]\n                                },\n                                options: {\n                                    responsive: true,\n                                    maintainAspectRatio: false\n                                }\n                            });\n                        }\n                    }\n                } catch (e) {\n                    Notification.exception(e);\n                }\n            }\n        };\n    }\n);\n"],"names":["define","Notification","init","data","strings","form","document","getElementById","btnAdd","btnCancel","addEventListener","svcId","ihForm","value","reset","classList","remove","add","nameField","focus","typeField","urlField","urlHelp","amqpBuilder","baseUrlContainer","querySelector","authTypeContainer","closest","responseQueueContainer","updateUiForType","textContent","url_help_amqp","startsWith","url_help_rest","syncAmqpUrl","host","port","user","pass","vhost","exchange","routingKey","queueDeclare","dlq","substring","eUser","encodeURIComponent","ePass","eHost","eVhost","url","params","push","length","join","querySelectorAll","forEach","el","e","exception","elStatus","Chart","ctxStatus","getContext","type","labels","success","failure","datasets","fail","backgroundColor","options","responsive","maintainAspectRatio","elLatency","ctxLatency","label","avglatency","latency","borderColor","tension","fill","font","fillStyle","textAlign","fillText","width","height"],"mappings":"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"}